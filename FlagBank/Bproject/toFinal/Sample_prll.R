#   보류. cut.grp 사이즈가 너무 커서 병렬 실행이 불가하다.

#   BProject 디렉토리에서 실행한다고 전제.
source("header.r")
source("B_H.R")


lastH <- 860
testMode <-                 # 실수 방지를 위해 일부러 오류 코드로 남김.
prllNum <-      # 실수가 잦아서 그냥 오류 코드로 놔둔다.

stdFiltedCnt <- 0:2
scoreMtx.name <- c("score2","score3","score4","score5","score6","score7","score9"   ,"score1","score8")
stdFilted.NG <- c("D0000.A","A0100.A","AP000.E")

load(sprintf("../Aproject/Obj_allIdxLstZ%d.save",lastH) )
load(sprintf("../Aproject/save/Obj_fRstLstZ%d.save",lastH) )
names(fRstLst) <- names(allIdxLst$stdFiltedCnt)
load(sprintf("../Aproject/save/Obj_gEnvZ%d.save",lastH))
load(sprintf("./save/Obj_remLstZ%d.save",lastH) )

prllLog <- k.getFlogObj( "./log/parallel_log.txt" )
prll.initHeader <- function( ){
    k <- sfLapply(1:prllNum,function(prllId){
        curWd <- getwd()
        setwd("..")
        source("hCommon.R")

        setwd( curWd )
        source("header.r")
        source("B_H.R")
    })
}

sfInit( parallel=T, cpus=prllNum )
sfExport("prllLog") ;sfExport("lastH")
sfExport("gEnv")    ;sfExport("fRstLst")    ;sfExport("allIdxLst")
prll.initHeader( )
prllLog$fLogStr("parallel init", pTime=T ,pAppend=F )
cat(sprintf("* Parallel ready... see log : %s \n",prllLog$fileName))


# -----------------------------------------------------------------------------------------
tStmp <- Sys.time()
stdMI.grp <- bUtil.getStdMILst( gEnv ,fRstLst )     ;stdMI.grp$anyWarn( )

hMtxLst <- B.makeHMtxLst( gEnv, allIdxLst, fRstLst, lastH=lastH, scoreMtx.name )    # 16 min.(30min for all)
stdCtrlCfgGrp <- bUtil.makeStdCtrlCfgGrp(hMtxLst)
cut.grp <- bFCust.getFCustGrp( stdCtrlCfgGrp ,hMtxLst )
sfExport("cut.grp")

tDiff <- Sys.time() - tStmp
sprintf("Time cost : %.1f%s",tDiff,units(tDiff))
# -----------------------------------------------------------------------------------------

for( curStdFiltedCnt in stdFiltedCnt ){   # curStdFiltedCnt <- stdFiltedCnt[1]

    aZoidGrp <- sprintf("allZoid.idx%d",curStdFiltedCnt)
    fHName <- bUtil.getSfcLstName( fRstLst[[length(fRstLst)]] ,curStdFiltedCnt=curStdFiltedCnt ,cut.grp )

    logger <- k.getFlogObj( sprintf("./log/FinalCut_%d_%s.txt",lastH,aZoidGrp) )
    logger$fLogStr(sprintf("start %s",aZoidGrp),pAppend=F,pTime=T)


    allIdxF <- allIdxLst[[aZoidGrp]]
    if( testMode ){
        allIdxF <- allIdxF[sample(1:length(allIdxF),5000)]
    }
    logger$fLogStr(sprintf("Initial size :%7d",length(allIdxF)),pTime=T)


    #   primary cut --------------------------------------------------------------------
    allIdxF <- FC.primaryCut.static( allIdxF ,gEnv )
    #   allIdxF <- FC.primaryCut.cust( allIdxF ,gEnv )
    logger$fLogStr(sprintf("FC.primaryCut :%7d",length(allIdxF)),pTime=T)

    #   primary cut .byScoreMtx --------------------------------------------------------
    for( tgt.scMtx in scoreMtx.name ){   # tgt.scMtx <- scoreMtx.name[1]

        filter.grp <- getFilter.grp( stdMI.grp ,tgt.scMtx=tgt.scMtx )

        # FC.primaryCut.bySC <- function( allIdxF ,gEnv ,filter.grp ,fHName ,cut.grp ,logFile="primaryCut.bySC.txt" )
        logFile <- sprintf("primaryCut.bySC_H%d_%s_%s.txt",lastH,aZoidGrp,tgt.scMtx)
        allIdxF <- FC.primaryCut.bySC.prll( allIdxF ,gEnv ,filter.grp ,fHName ,cut.grp ,logFile=logFile)

        logger$fLogStr(sprintf("FC.primaryCut.bySC - size :%7d  tgt.scMtx:%s",length(allIdxF),tgt.scMtx),pTime=T)
    }
    gc()

    #   bUtil.cut( ) --------------------------------------------------------------------
    for( tgt.scMtx in scoreMtx.name ){   # tgt.scMtx <- scoreMtx.name[1]

        logger$fLogStr(sprintf("bUtil.cut( ) - tgt.scMtx:%s",tgt.scMtx),pTime=T)

        filter.grp <- getFilter.grp( stdMI.grp ,tgt.scMtx=tgt.scMtx )

        surFlag <- rep( T ,length(allIdxF) )
        bLst <- k.blockLst( length(allIdxF) ,1000*ifelse(testMode,1,100) )

        sfExport( "tgt.scMtx" ) ;sfExport("filter.grp") ;sfExport("allIdxF")    ;sfExport("fHName")
        resultLst <- sfLapply( bLst ,function( blk ){
            tStmp <- Sys.time()
            span <- blk["start"]:blk["end"] 

            scoreMtx.grp <- getScoreMtx.grp( gEnv$allZoidMtx[allIdxF[span],,drop=F] ,filter.grp )
            cutRst <- bUtil.cut( scoreMtx.grp ,cut.grp ,fHName ,tgt.scMtx=tgt.scMtx ,logger=NULL )

            tDiff <- Sys.time() - tStmp
            logStr <- sprintf("  block finished. %d/%d  %5.1f%s for %d~%d "
                                ,sum(!cutRst$surFlag),length(cutRst$surFlag)
                                ,tDiff  ,units(tDiff)
                                ,blk["start"] ,blk["end"]
                        )
            prllLog$fLogStr( logStr )
            
            return( list( surFlag=cutRst$surFlag ,blk=blk ) )
        })
        for( idx in seq_len(length(resultLst)) ){
            blk <- resultLst[[idx]]$blk
            surFlag[ blk["start"]:blk["end"] ] <- resultLst[[idx]]$surFlag
        }

        allIdxF <- allIdxF[surFlag]
        logger$fLogStr(sprintf("   - final size :%7d",length(allIdxF)),pTime=T)
    }

    #   QQE 다중 scoreMtx 필터링 추가.

    rptFile <- sprintf("./report/FinalCut_H%d%s_%d.txt",lastH,aZoidGrp,length(allIdxF) )
    zoidMtx <- gEnv$allZoidMtx[allIdxF,,drop=F]     ;rownames(zoidMtx) <- sprintf("%3d:",1:nrow(zoidMtx))
    finalRpt <- k.getFlogObj( rptFile )
    finalRpt$fLogMtx( zoidMtx ,pIndent=" " )
    logger$fLogStr( sprintf("      reported in %s",rptFile) ,pConsole=T )
    logger$fLogStr( "Mission complete." ,pConsole=T ,pTime=T )


}   # for( stdFiltedCnt )
